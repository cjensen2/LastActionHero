<!DOCTYPE html>
<html>
<head>
    <title>LastActionHero</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var me=this;Deft.Promise.all([me.readWorkspaces(),me.readWorkspacePermissions(),me.readUsers()],me).then({success:function(results){console.log("results",results);var workspaces=_.first(results),permissions=results[1];me.setUserCounts(workspaces,permissions),me.setFeatureCounts(workspaces)}})},createChart:function(series){var me=this;me.setLoading(!1),_.isUndefined(me.chart)||me.remove(me.chart),me.chart=Ext.create("Rally.technicalservices.lahChart",{itemId:"rally-chart",chartData:{series:series},title:"Workspace Visualization"}),me.add(me.chart)},prepareChartData:function(workspaces){var seriesData=_.map(workspaces,function(ws){return{name:ws.get("Name"),y:ws.get("WorkspaceFeatureCount"),x:100,z:ws.get("UserWorkspaceCount")}}),series=[{data:seriesData}];return console.log("seriesData",series),series},setFeatureCounts:function(workspaces){var me=this;me.readWorkspaceFeatures(workspaces).then({success:function(values){console.log("values",values),_.each(workspaces,function(workspace,i){workspace.set("WorkspaceFeatureCount",values[i].length)}),console.log("workspaces",_.map(workspaces,function(w){return w.get("Name")+"-"+w.get("UserWorkspaceCount")+":"+w.get("ProjectsCount")})),me.createChart(me.prepareChartData(workspaces))},failure:function(error){console.log("Error:",error)}})},setProjectCounts:function(workspaces){var me=this;me.readProjects(workspaces).then({success:function(values){console.log("project values",values),_.each(workspaces,function(workspace,i){workspace.set("WorkspaceProjects",values[i]),workspace.set("ProjectsCount",values[i].length)})}})},setUserCounts:function(workspaces,permissions){_.each(workspaces,function(ws,i){var perms=_.filter(permissions,function(perm){return perm.get("Workspace")._ref===ws.get("_ref")&&"User"===perm.get("Role")});ws.set("UserWorkspaceCount",perms.length)})},readProjects:function(workspaces){var me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("Project",["Name","State"],[],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},readWorkspacePermissions:function(){var deferred=Ext.create("Deft.Deferred");return this._loadAStoreWithAPromise("WorkspacePermission",["Workspace","User","Name","Role"]).then({scope:this,success:function(permissions){console.log("permissions",permissions),deferred.resolve(permissions)}}),deferred.promise},readWorkspaces:function(){var deferred=Ext.create("Deft.Deferred");return this._loadAStoreWithAPromise("Subscription",["Name","Workspaces"]).then({success:function(subs){var sub=_.first(subs);sub.getCollection("Workspaces").load({fetch:["ObjectID","Name","State"],callback:function(records,operation,success){console.log("workspaces",_.map(records,function(r){return r.get("Name")}));var recs=_.filter(records,function(r){return"Closed"!==r.get("State")&&-1==r.get("Name").toLowerCase().indexOf("kfwang")});console.log("Workspace Count:",recs.length),deferred.resolve(recs)}})},scope:this}),deferred.promise},readUsers:function(){var deferred=Ext.create("Deft.Deferred");return this._loadAStoreWithAPromise("User",["UserName","UserPermissions"]).then({success:function(users){deferred.resolve(users)},scope:this}),deferred.promise},readPortfolioItems:function(workspaces){var me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me.readFeatures(workspace).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){console.log("error:",error),deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},readWorkspaceFeatures:function(workspaces){var createFeatureFilter=function(){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:">",value:"2015-01-01T00:00:00.000Z"});return filter},me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("PortfolioItem",["ObjectID"],[createFeatureFilter()],{project:null,workspace:workspace.get("_ref")}).then({scope:me,success:function(pis){deferred.resolve(pis)}}),deferred.promise});return Deft.Promise.all(promises)},readFeatures:function(workspace){var me=this,createFeatureFilter=function(){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:">",value:"2015-01-01T00:00:00.000Z"});return filter},readFeatureType=function(){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("TypeDefinition",["TypePath"],[{property:"Ordinal",operator:"=",value:0}],{project:null,workspace:workspace.get("_ref")}).then({scope:me,success:function(types){deferred.resolve(_.first(types).get("TypePath"))}}),deferred.promise},readFeatures=function(type){console.log("Reading:",type);var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise(type,["FormattedID","Name","ObjectID","CreationDate"],[createFeatureFilter()],{project:null,workspace:workspace.get("_ref")}).then({scope:me,success:function(features){console.log("Features:",features.length),deferred.resolve(features)}}),deferred.promise},deferred=Ext.create("Deft.Deferred");return Deft.Chain.pipeline([readFeatureType,readFeatures],self).then({success:function(results){deferred.resolve(results)},failure:function(error){console.log("error:",error)}}),deferred.promise},_loadAStoreWithAPromise:function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise}});
                Ext.define("Rally.technicalservices.lahChart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{colors:["#E0E0E0","#00a9e0","#fad200","#8dc63f"],chart:{type:"bubble"},title:{text:"Progress by Project"},xAxis:{title:{text:"# Projects"}},yAxis:[{title:{text:"Activity"}}]},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"LastActionHero",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
